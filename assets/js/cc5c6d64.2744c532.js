(window.webpackJsonp=window.webpackJsonp||[]).push([[172],{242:function(e,n,a){"use strict";a.r(n),a.d(n,"frontMatter",(function(){return l})),a.d(n,"metadata",(function(){return o})),a.d(n,"toc",(function(){return s})),a.d(n,"default",(function(){return p}));var t=a(3),i=a(8),r=(a(0),a(281)),l={title:"Magical Call"},o={unversionedId:"miscellaneous/magical-call",id:"version-9.x/miscellaneous/magical-call",isDocsHomePage:!1,title:"Magical Call",description:"- The Magical Call",source:"@site/versioned_docs/version-9.x/miscellaneous/magical-call.md",sourceDirName:"miscellaneous",slug:"/miscellaneous/magical-call",permalink:"/docs/9.x/miscellaneous/magical-call",editUrl:"https://github.com/apiato/documentation/tree/master/versioned_docs/version-9.x/miscellaneous/magical-call.md",version:"9.x",lastUpdatedBy:"Moslem Deris",lastUpdatedAt:1618096631,formattedLastUpdatedAt:"4/10/2021",frontMatter:{title:"Magical Call"},sidebar:"version-9.x/docs",previous:{title:"Values",permalink:"/docs/9.x/optional-components/values"},next:{title:"Tests Helpers",permalink:"/docs/9.x/miscellaneous/tests-helpers"}},s=[{value:"The Magical Call",id:"the-magical-call",children:[{value:"Usage options",id:"usage-options",children:[]}]},{value:"Transactional Magical Call",id:"transactional-call",children:[]},{value:"Use case example",id:"use-case-example",children:[{value:"The ListUsersTask class",id:"the-list-users-task-class",children:[]}]}],c={toc:s};function p(e){var n=e.components,a=Object(i.a)(e,["components"]);return Object(r.b)("wrapper",Object(t.a)({},c,a,{components:n,mdxType:"MDXLayout"}),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},Object(r.b)("a",{parentName:"li",href:"#the-magical-call"},"The Magical Call"),Object(r.b)("ul",{parentName:"li"},Object(r.b)("li",{parentName:"ul"},Object(r.b)("a",{parentName:"li",href:"#usage-options"},"Usage options"),Object(r.b)("ul",{parentName:"li"},Object(r.b)("li",{parentName:"ul"},Object(r.b)("a",{parentName:"li",href:"#basic-usage"},"Basic Usage")),Object(r.b)("li",{parentName:"ul"},Object(r.b)("a",{parentName:"li",href:"#passing-arguments-to-the-run-function"},"Passing arguments to the run function")),Object(r.b)("li",{parentName:"ul"},Object(r.b)("a",{parentName:"li",href:"#calling-other-functions-before-the-run"},"Calling other functions before the run")),Object(r.b)("li",{parentName:"ul"},Object(r.b)("a",{parentName:"li",href:"#calling-other-functions-and-pass-them-arguments"},"Calling other functions and pass them arguments:")))))),Object(r.b)("li",{parentName:"ul"},Object(r.b)("a",{parentName:"li",href:"#transactional-call"},"Transactional Magical Call")),Object(r.b)("li",{parentName:"ul"},Object(r.b)("a",{parentName:"li",href:"#use-case-example"},"Use case example:"),Object(r.b)("ul",{parentName:"li"},Object(r.b)("li",{parentName:"ul"},Object(r.b)("a",{parentName:"li",href:"#the-list-users-task-class"},"The ListUsersTask class:"))))),Object(r.b)("h2",{id:"the-magical-call"},"The Magical Call"),Object(r.b)("p",null,"This magical function allows you to call any Action or Task ",Object(r.b)("inlineCode",{parentName:"p"},"run")," function, from anywhere. Using the ",Object(r.b)("inlineCode",{parentName:"p"},"Apiato::call()")," Facade."),Object(r.b)("p",null,"The function ",Object(r.b)("inlineCode",{parentName:"p"},"call")," is mainly used for calling Apiato ",Object(r.b)("inlineCode",{parentName:"p"},"Actions")," from ",Object(r.b)("inlineCode",{parentName:"p"},"Controllers")," and for calling Apiato ",Object(r.b)("inlineCode",{parentName:"p"},"Tasks"),"\nfrom ",Object(r.b)("inlineCode",{parentName:"p"},"Actions"),"."),Object(r.b)("p",null,"Each Action knows which UI called it, using ",Object(r.b)("inlineCode",{parentName:"p"},"$this->getUI()"),", this is useful for handling the same Action differently\nbased on the UI type (Web or API). This will work when calling the Action from Controllers and Commands using the\nmagical ",Object(r.b)("inlineCode",{parentName:"p"},"call()")," function."),Object(r.b)("h3",{id:"usage-options"},"Usage options"),Object(r.b)("p",null,"In the first argument you can pass the class full name, as follows ",Object(r.b)("inlineCode",{parentName:"p"},"App\\Containers\\User\\Tasks\\CreateUserTask::class"),",\nor you can pass the container name and class name, as follows ",Object(r.b)("inlineCode",{parentName:"p"},"User@CreateUserTask"),"."),Object(r.b)("p",null,"It is highly recommended to use Apiato caller style ",Object(r.b)("inlineCode",{parentName:"p"},"containerName@className")," as it helps to remove direct\ndependencies between containers. The function will verify the Container exist before calling the function and inform\nthe user to install Container if not exist."),Object(r.b)("p",null,'Note: When a class is directly called using his full name, a warning will be logged informing you to use the\n"apiato caller style". This info, however, can be disabled by changing the flag\n',Object(r.b)("inlineCode",{parentName:"p"},"apiato.logging.log-wrong-apiato-caller-style")," in the ",Object(r.b)("inlineCode",{parentName:"p"},"Ship/Configs/apiato.php")," file accordingly."),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre",className:"language-php"},'<?php\n\n// Call "AssignUserToRoleTask" Task from the "Authorization" Container using the apiato caller style\nApiato::call(\'Authorization@AssignUserToRoleTask\');\n\n// Call "AssignUserToRoleTask" Task from the "Authorization" Container using class full name.\n// This will cause to add an INFO entry to the log file!\nApiato::call(\\App\\Containers\\Authorization\\Tasks\\AssignUserToRoleTask::class);\n')),Object(r.b)("h5",{id:"basic-usage"},"Basic Usage"),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre",className:"language-php"},"$foo = \\Apiato\\Core\\Foundation\\Facades\\Apiato::call('Container@ActionOrTask');\n")),Object(r.b)("p",null,Object(r.b)("strong",{parentName:"p"},"Notes"),":"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},"From Controllers and Actions you can use the ",Object(r.b)("inlineCode",{parentName:"li"},"$this->call('Container@ActionOrTask')")," instead of the Facade, but it's not recommended."),Object(r.b)("li",{parentName:"ul"},"The magical ",Object(r.b)("inlineCode",{parentName:"li"},"call")," function accepts the class full namespace (",Object(r.b)("inlineCode",{parentName:"li"},"\\App\\Containers\\User\\Tasks\\GetAllUsersTask::class"),"), and Apiato caller style (",Object(r.b)("inlineCode",{parentName:"li"},"Containers@GetAllUsersTask"),")."),Object(r.b)("li",{parentName:"ul"},"There is also a ",Object(r.b)("inlineCode",{parentName:"li"},"transactionalCall()")," method available, that wraps everything in a ",Object(r.b)("inlineCode",{parentName:"li"},"DB::Transaction")," (see below).")),Object(r.b)("h5",{id:"passing-arguments-to-the-run-function"},"Passing arguments to the ",Object(r.b)("inlineCode",{parentName:"h5"},"run")," function"),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre",className:"language-php"},"$foo = Apiato::call('Container@ActionOrTask', [$runArgument1, $runArgument2, $runArgument3]);\n")),Object(r.b)("h5",{id:"calling-other-functions-before-the-run"},"Calling other functions before calling the ",Object(r.b)("inlineCode",{parentName:"h5"},"run")),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre",className:"language-php"},"$foo = Apiato::call('Container@ActionOrTask', [$runArgument], ['otherFunction1', 'otherFunction2']);\n")),Object(r.b)("h5",{id:"calling-other-functions-and-pass-them-arguments"},"Calling other functions and pass them arguments before calling the ",Object(r.b)("inlineCode",{parentName:"h5"},"run")),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre",className:"language-php"},"<?php\n$foo = Apiato::call('Container@ActionOrTask', [$runArgument], [\n    [\n       'function1' => ['function1-argument1', 'function1-argument2']\n    ],\n    [\n       'function2' => ['function2-argument1']\n    ],\n]);\n\n$foo = Apiato::call('Container@ActionOrTask', [$runArgument], [\n    'function-without-argument',\n    [\n      'function1' => ['function1-argument1', 'function1-argument2']\n    ],\n]);\n\n$foo = Apiato::call('Container@ActionOrTask', [], [\n    'function-without-argument',\n    [\n      'function1' => ['function1-argument1', 'function1-argument2']\n    ],\n    'another-function-without-argument',\n    [\n      'function2' => ['function2-argument1', 'function2-argument2', 'function2-argument3']\n    ],\n]);\n")),Object(r.b)("h2",{id:"transactional-call"},"Transactional Magical Call"),Object(r.b)("p",null,"Sometimes, you want to wrap a call into one ",Object(r.b)("inlineCode",{parentName:"p"},"Database Transaction")," (see\n",Object(r.b)("a",{parentName:"p",href:"https://laravel.com/docs/master/database#database-transactions"},"Laravel Documentation"),")."),Object(r.b)("p",null,"Consider the following example: You want to create a new ",Object(r.b)("inlineCode",{parentName:"p"},"Team")," and automatically assign yourself (i.e., your own\n",Object(r.b)("inlineCode",{parentName:"p"},"User"),") to this newly created ",Object(r.b)("inlineCode",{parentName:"p"},"Team"),". Your ",Object(r.b)("inlineCode",{parentName:"p"},"CreateTeamAction")," may call a dedicated ",Object(r.b)("inlineCode",{parentName:"p"},"CreateTeamTask")," and a\n",Object(r.b)("inlineCode",{parentName:"p"},"AssignMemberToTeamTask")," afterwards."),Object(r.b)("p",null," However, if the ",Object(r.b)("inlineCode",{parentName:"p"},"AssignMemberToTeamTask"),' fails, for unknown reasons, you may want to "rollback" (i.e., remove) the\nnewly created ',Object(r.b)("inlineCode",{parentName:"p"},"Team")," from the database in order to keep the database in a valid state."),Object(r.b)("p",null," That's where ",Object(r.b)("inlineCode",{parentName:"p"},"DB::transactions")," comes into play!"),Object(r.b)("p",null," Apiato provides a ",Object(r.b)("inlineCode",{parentName:"p"},"transactionalCall($class, $params, $extraMethods)")," method with the similar parameters as already\nknown from the  ",Object(r.b)("inlineCode",{parentName:"p"},"call()")," method. Internally, this method calls this ",Object(r.b)("inlineCode",{parentName:"p"},"call()")," method anyways, but wraps it into a\n",Object(r.b)("inlineCode",{parentName:"p"},"DB::transaction"),"."),Object(r.b)("p",null," If any ",Object(r.b)("inlineCode",{parentName:"p"},"Exception")," occurs during the execution of the ",Object(r.b)("inlineCode",{parentName:"p"},"$class")," to be called, everything done in this context is\nautomatically rolled-back from the database. However, respective operations on the file system (e.g., you may also\nhave uploaded a profile picture for this ",Object(r.b)("inlineCode",{parentName:"p"},"Team")," already that needs to be removed in this case) need to be performed\nmanually!"),Object(r.b)("p",null," Typically, you may want to use the ",Object(r.b)("inlineCode",{parentName:"p"},"transactionalCall()")," on the ",Object(r.b)("inlineCode",{parentName:"p"},"Controller")," level!"),Object(r.b)("h2",{id:"use-case-example"},"Use case example"),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre",className:"language-php"},"<?php\n\nreturn Apiato::call('User@ListUsersTask', [], ['ordered']);\n// can be called this way as well Apiato::call(ListUsersTask::class, [], ['ordered']);\n\nreturn Apiato::call('User@ListUsersTask', [], ['ordered', 'clients']);\n\nreturn Apiato::call('User@ListUsersTask', [], ['admins']);\n\nreturn Apiato::call('User@ListUsersTask', [], ['admins', ['roles' => ['manager', 'employee']]]);\n")),Object(r.b)("h3",{id:"the-list-users-task-class"},"The ListUsersTask class"),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre",className:"language-php"},"<?php\n\nnamespace App\\Containers\\User\\Tasks;\n\nuse App\\Containers\\User\\Data\\Criterias\\AdminsCriteria;\nuse App\\Containers\\User\\Data\\Criterias\\ClientsCriteria;\nuse App\\Containers\\User\\Data\\Criterias\\RoleCriteria;\nuse App\\Containers\\User\\Data\\Repositories\\UserRepository;\nuse App\\Ship\\Criterias\\Eloquent\\OrderByCreationDateDescendingCriteria;\nuse App\\Ship\\Parents\\Tasks\\Task;\n\nclass ListUsersTask extends Task\n{\n    private $userRepository;\n\n    public function __construct(UserRepository $userRepository)\n    {\n        $this->userRepository = $userRepository;\n    }\n\n    public function run()\n    {\n        return $this->userRepository->paginate();\n    }\n\n    public function clients()\n    {\n        $this->userRepository->pushCriteria(new ClientsCriteria());\n    }\n\n    public function admins()\n    {\n        $this->userRepository->pushCriteria(new AdminsCriteria());\n    }\n\n    public function ordered()\n    {\n        $this->userRepository->pushCriteria(new OrderByCreationDateDescendingCriteria());\n    }\n\n    public function withRole($roles)\n    {\n        $this->userRepository->pushCriteria(new RoleCriteria($roles));\n    }\n\n}\n\n")))}p.isMDXComponent=!0},281:function(e,n,a){"use strict";a.d(n,"a",(function(){return u})),a.d(n,"b",(function(){return d}));var t=a(0),i=a.n(t);function r(e,n,a){return n in e?Object.defineProperty(e,n,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[n]=a,e}function l(e,n){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);n&&(t=t.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),a.push.apply(a,t)}return a}function o(e){for(var n=1;n<arguments.length;n++){var a=null!=arguments[n]?arguments[n]:{};n%2?l(Object(a),!0).forEach((function(n){r(e,n,a[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):l(Object(a)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(a,n))}))}return e}function s(e,n){if(null==e)return{};var a,t,i=function(e,n){if(null==e)return{};var a,t,i={},r=Object.keys(e);for(t=0;t<r.length;t++)a=r[t],n.indexOf(a)>=0||(i[a]=e[a]);return i}(e,n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(t=0;t<r.length;t++)a=r[t],n.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(i[a]=e[a])}return i}var c=i.a.createContext({}),p=function(e){var n=i.a.useContext(c),a=n;return e&&(a="function"==typeof e?e(n):o(o({},n),e)),a},u=function(e){var n=p(e.components);return i.a.createElement(c.Provider,{value:n},e.children)},b={inlineCode:"code",wrapper:function(e){var n=e.children;return i.a.createElement(i.a.Fragment,{},n)}},m=i.a.forwardRef((function(e,n){var a=e.components,t=e.mdxType,r=e.originalType,l=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),u=p(a),m=t,d=u["".concat(l,".").concat(m)]||u[m]||b[m]||r;return a?i.a.createElement(d,o(o({ref:n},c),{},{components:a})):i.a.createElement(d,o({ref:n},c))}));function d(e,n){var a=arguments,t=n&&n.mdxType;if("string"==typeof e||t){var r=a.length,l=new Array(r);l[0]=m;var o={};for(var s in n)hasOwnProperty.call(n,s)&&(o[s]=n[s]);o.originalType=e,o.mdxType="string"==typeof e?e:t,l[1]=o;for(var c=2;c<r;c++)l[c]=a[c];return i.a.createElement.apply(null,l)}return i.a.createElement.apply(null,a)}m.displayName="MDXCreateElement"}}]);